<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="./IMG/icon.png" type="image/x-icon">
    <title>Jogo das Cores</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bangers&family=Lilita+One&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Permanent+Marker&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&family=Squada+One&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap"
        rel="stylesheet">
    <style>
        html,
        body {
            overflow: hidden;
            position: fixed;
            height: 100vh;
            width: 100vw;
            margin: 0;
        }

        .IPergunta {
            padding: 0;
            margin: 0;
            width: 100vw;
            height: 100vh;
            border: none;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        h1 {
            z-index: 0;
        }

        .Time {
            font-family: "Lilita One", sans-serif;
            font-weight: 400;
            font-style: normal;
            color: white;
            position: absolute;
            top: 0;
            right: 0;
            z-index: 0;
        }

        @media (orientation: landscape) {
            .Time {
                font-size: 5vw;
                margin: 15px 30px 0 0;
            }

            .EsperandoDiv h1 {
                font-size: 7vh;
            }

            .JogoStartdontgo h1 {
                font-size: 7vh;
            }

            .JogoStartdontgo h2 {
                font-size: 6vh;
            }
        }

        @media (orientation: portrait) {
            .Time {
                font-size: 10vw;
                margin: 10px 20px 0 0;
            }

            .EsperandoDiv h1 {
                font-size: 8.5vw;
            }

            .JogoStartdontgo h1 {
                font-size: 10vw;
            }

            .JogoStartdontgo h2 {
                font-size: 6vw;
            }
        }

        .off {
            z-index: 9;
            position: fixed;
            left: 0;
            top: 0;
            transform: translate(15px, -5px);
            font-size: 15px;
            color: rgb(255, 170, 170);
            width: 100px;
            height: 100px;
        }

        .JogoStartdontgo {
            width: 100vw;

            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .JogoStartdontgo h2 {
            font-family: "Nunito Sans", sans-serif;
            font-optical-sizing: auto;
            font-style: normal;
            font-variation-settings:
                "wdth" 100,
                "YTLC" 500;
        }

        .EsperandoDiv {
            width: 100vw;

            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
    <div class="Every">
        <h1 id="TituloInicial">Jogo das Cores</h1>
        <nav>
            <button onclick="NewName()" class="off" id="off" style="display: none;">Desconectar</button>
        </nav>
        <div id="EntrarArea" style="display: none;">
            <div class="Entrar" style="display: none;" c>

                <div class="configlogin">
                    <h2><label for="nomeJogador">Nome do Jogador</label></h2>
                    <div class="erroLog"></div>
                    <input type="text" name="nomeJogador" id="nomeJogador" oninput="TestarDigito()"
                        placeholder="Digite seu nome" /><br>
                    <input type="button" value="Entrar" onclick="entrar()" />
                </div>
            </div>
        </div>
        <div class="Main" style="display: none;"></div>
        <div class="JogoStartdontgo"></div>
        <div class="Time" style="display: none;" id="Time">00:00</div>
    </div>
    <div class="ForaDoAr">
        <h1>O host não está ativado!</h1>
    </div>
</body>
<script src="./JS/EntrarConfig.js"></script>

<script type="module">
 // Utilitários para localStorage
function getLocal(key, fallback = null) {
    const val = localStorage.getItem(key);
    return val !== null ? val : fallback;
}
function setLocal(key, value) {
    localStorage.setItem(key, value);
}

// Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Variáveis globais
let pontosGravados = -1;
let JogadorOnline = false;
let RespostasID = -1;
let FimDeTempo = false;
let Tempo = 0, tempoRef, tempoDaPergunta;
const jogoRef = ref(db, "Host");

// Entrar no jogo
window.EntrarNoJogo = function (name) {
    const jogadoresRef = ref(db, 'Jogadores');
    const novoJogadorRef = push(jogadoresRef);

    setLocal('jogadorRefKey', novoJogadorRef.key);
    setLocal('nomeJogador', name);

    set(novoJogadorRef, {
        nome: name,
        perguntas: { "0": -1 },
        pontos: { "0": 0 }
    }).then(() => {
        JogadorOnline = true;
        console.log("Jogador entrou no jogo");
    }).catch(console.error);

    onDisconnect(novoJogadorRef).remove();
    Reiniciar();
};

// Sair do jogo
window.SairDoJogo = function () {
    const jogadorRefKey = getLocal('jogadorRefKey');
    if (!jogadorRefKey) return;

    remove(ref(db, `Jogadores/${jogadorRefKey}`)).catch(console.error);

    JogadorOnline = false;
    localStorage.removeItem('jogadorRefKey');
    localStorage.removeItem('nomeJogador');
    document.querySelector(".Main").innerHTML = "";
    location.reload();
};

// Atualização do jogo
function atualizarJogo(dados) {
    document.getElementById("TituloInicial").style.display = "block";
    document.querySelector(".JogoStartdontgo").innerHTML = "";
    document.querySelector(".Main").innerHTML = "";
    document.getElementById("EntrarArea").style.display = "block";

    if (!(dados && dados.iniciado)) {
        SairDoJogo();
        document.querySelector(".ForaDoAr").style.display = 'block';
        document.querySelector(".Every").style.display = 'none';
        document.querySelector(".Time").style.display = 'none';
        return;
    }

    tempoRef = dados.Time;

    // Mostrar interface do jogo
    document.querySelector(".ForaDoAr").style.display = 'none';
    document.querySelector(".Every").style.display = 'block';
    document.querySelector('.Main').style.display = 'block';
    document.querySelector('.Main').innerHTML = `<div class="EsperandoDiv"><h1>Esperando a Partida Começar</h1></div>`;

    // Se jogador não está online
    if (!JogadorOnline) {
        if (dados.PerguntasStart) {
            document.getElementById('EntrarArea').style.display = 'none';
            document.querySelector('.JogoStartdontgo').innerHTML = `<h1>Jogo já iniciado!</h1><br><h2>Espere o host iniciar novamente!</h2>`;
        }
        return;
    }

    if (dados.PerguntasStart) {
        document.getElementById("TituloInicial").style.display = "none";
        document.querySelector('.Main').innerHTML = `<iframe class="IPergunta" src="./Perguntas/${dados.PerguntasID}.html?type=Player"></iframe>`;
        document.querySelector(".Time").style.display = 'block';
        RespostasID = dados.PerguntasID;
        setLocal("RespontaID", dados.PerguntasID);
    } else {
        document.querySelector(".Time").style.display = 'none';
    }
}

// Reiniciar
function Reiniciar() {
    get(jogoRef).then((snapshot) => {
        if (snapshot.exists()) atualizarJogo(snapshot.val());
    }).catch(err => console.error("Erro ao reiniciar:", err));
}

// Escuta em tempo real
onValue(jogoRef, (snapshot) => {
    atualizarJogo(snapshot.val());
});

// Loop principal 
setInterval(() => {
    const jogadorRefKey = getLocal('jogadorRefKey');
    if (!jogadorRefKey) return;

    const jogadorRef = ref(db, `Jogadores/${jogadorRefKey}`);
    const pontosRef = ref(db, `Jogadores/${jogadorRefKey}/pontos/`);
    const perguntasRef = ref(db, `Jogadores/${jogadorRefKey}/perguntas/`);

    // Atualiza status do jogador
    get(jogadorRef).then(snapshot => {
        if (!snapshot.exists()) {
            // Desconectado em outra aba
            localStorage.removeItem('nomeJogador');
            localStorage.removeItem('jogadorRefKey');
            JogadorOnline = false;
            document.getElementById('off').style.display = 'none';
            document.querySelector('.Entrar').style.display = 'block';
            document.querySelector('.Main').style.display = 'none';
            document.querySelector(".Time").style.display = 'none';
            console.log("Jogador desconectado automaticamente (outra aba fechou)");
            return;
        }

        const dados = snapshot.val();
        const RespontaIDLocal = getLocal("RespontaID", -1);
        const RespostaDoJogador = getLocal("RespostaDoJogador", -1);

        // Salvar resposta
        if (dados.perguntas?.[RespontaIDLocal] == -1 && RespostaDoJogador != -1 && !FimDeTempo) {
            update(perguntasRef, { [RespontaIDLocal]: RespostaDoJogador });
        }

        // Calcular pontos
        if (!FimDeTempo && pontosGravados === -1) {
            pontosGravados = (RespostaDoJogador == getLocal("RespostaCorreta")) ? (Tempo * 123) : 0;
        } else if (FimDeTempo && pontosGravados != -1) {
            update(pontosRef, { [RespontaIDLocal]: pontosGravados });
            pontosGravados = -1;
        }
    });

    // Atualiza tempo
    if (RespostasID == -1) return;

    get(ref(db, "Respostas")).then(snapshot => {
        if (snapshot.exists()) {
            const dados = snapshot.val();
            tempoDaPergunta = dados[RespostasID]?.Time;
            setLocal("RespostaCorreta", dados[RespostasID]?.Resposta);
        }
    });

    if (tempoRef > 1 && tempoDaPergunta > 0) {
        Tempo = Math.ceil((Date.now() - tempoRef) / 1000 - tempoDaPergunta);
    }

    if (Tempo >= 0) {
        FimDeTempo = false;
        const minutos = Math.floor(Tempo / 60);
        const segundos = Tempo % 60;
        document.getElementById("Time").innerText = 
            `${minutos.toString().padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
    } else if (!FimDeTempo) {
        document.querySelector('.Main').innerHTML = `<iframe class="IPergunta" src="./Perguntas/${RespostasID}.html?type=PlayerEnd"></iframe>`;
        FimDeTempo = true;
    }
}, 1000);

</script>


</html>